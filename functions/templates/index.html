<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ì¼€ì¤„</title>
    <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 1.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: background 0.3s;
        }

        .logout-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .calendar-header {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease-in-out;
            text-decoration: none;
            display: inline-block;
            font-weight: 500;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5a67d8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .calendar-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 2rem;
        }

        #calendar {
            max-width: 100%;
            margin: 0 auto;
        }

        .fc-toolbar {
            margin-bottom: 1.5rem !important;
        }

        .fc-toolbar-title {
            font-size: 1.5rem !important;
            font-weight: 600 !important;
            color: #333 !important;
        }

        .fc-button-primary {
            background: #667eea !important;
            border-color: #667eea !important;
            font-weight: 500 !important;
        }

        .fc-button-primary:hover {
            background: #5a67d8 !important;
            border-color: #5a67d8 !important;
        }

        .fc-button-primary:not(:disabled):active,
        .fc-button-primary:not(:disabled).fc-button-active {
            background: #4c51bf !important;
            border-color: #4c51bf !important;
        }

        .fc-event {
            border-radius: 4px !important;
            border: none !important;
            padding: 2px 4px !important;
            font-size: 0.85rem !important;
            cursor: pointer !important;
        }

        .fc-event.own-event {
            background: #667eea !important;
            color: white !important;
        }

        .fc-event.shared-event {
            background: #28a745 !important;
            color: white !important;
        }

        .fc-event.all-event {
            background: #17a2b8 !important;
            color: white !important;
        }

        .fc-daygrid-event-harness {
            margin-bottom: 2px !important;
        }

        .fc-day-today {
            background: rgba(102, 126, 234, 0.1) !important;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background-color: white;
            margin: 2% auto;
            padding: 2rem;
            border-radius: 15px;
            width: 95%;
            max-width: 600px;
            position: relative;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            transition: color 0.3s;
        }

        .close:hover {
            color: #000;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            height: 80px;
        }

        .time-section {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .time-section h4 {
            margin-bottom: 1rem;
            color: #333;
        }

        .date-input {
            margin-bottom: 1rem;
        }

        .ampm-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .ampm-option {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s ease-in-out;
            font-weight: 500;
            font-size: 0.95rem;
        }

        .ampm-option.selected {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .ampm-option:hover:not(.selected) {
            border-color: #667eea;
            background: #f0f2ff;
        }

        .time-picker-group {
            display: flex;
            gap: 0.5rem;
        }

        .time-picker-group select {
            flex: 1;
            padding: 0.75rem;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .share-section {
            border-top: 1px solid #e1e5e9;
            padding-top: 1.5rem;
            margin-top: 1.5rem;
        }

        .share-section h3 {
            color: #333;
            margin-bottom: 1rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin: 0;
        }

        .event-details {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
        }

        .event-details h3 {
            color: #333;
            margin-bottom: 0.5rem;
        }

        .event-details p {
            color: #666;
            margin: 0.25rem 0;
        }

        .legend {
            display: flex;
            gap: 1rem;
            align-items: center;
            font-size: 0.9rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .own-color { background: #667eea; }
        .shared-color { background: #28a745; }
        .all-color { background: #17a2b8; }

        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: #f8f9fa;
            padding: 0.5rem;
            border-radius: 8px;
        }

        .view-option {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 6px;
            background: transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .view-option.active {
            background: #667eea;
            color: white;
        }

        .view-option:hover:not(.active) {
            background: white;
        }

        .error-alert {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 1rem;
            border-radius: 8px;
            margin: 1rem 0;
            font-size: 0.9rem;
            display: none;
        }

        .error-alert.show {
            display: block;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }
            
            .calendar-header {
                flex-direction: column;
                align-items: stretch;
            }
            
            .calendar-header .btn {
                width: 100%;
                text-align: center;
            }
            
            .calendar-container {
                padding: 1rem;
            }
            
            .fc-toolbar {
                flex-direction: column !important;
                gap: 1rem !important;
            }
            
            .fc-toolbar-chunk {
                display: flex !important;
                justify-content: center !important;
            }

            .time-picker-group {
                flex-direction: column;
                gap: 1rem;
            }

            .form-actions {
                flex-direction: column;
            }

            .legend {
                justify-content: center;
            }

            .view-toggle {
                justify-content: center;
            }
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #666;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 0.75rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #f5c6cb;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 0.75rem;
            border-radius: 5px;
            margin: 1rem 0;
            border: 1px solid #c3e6cb;
        }

        .admin-section {
            margin-bottom: 2rem;
        }

        .users-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
        }

        .user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
        }

        .user-item:hover {
            background: #f8f9fa;
        }

        .user-item:last-child {
            border-bottom: none;
        }

        .user-info-admin {
            flex: 1;
        }

        .user-name {
            font-weight: bold;
            color: #333;
        }

        .user-stats {
            font-size: 0.9rem;
            color: #666;
            margin-top: 0.25rem;
        }

        .admin-badge {
            background: #ffd700;
            color: #333;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: bold;
            margin-left: 0.5rem;
        }

        .user-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-small {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
            border-radius: 4px;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #666;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“… ìŠ¤ì¼€ì¤„</h1>
        <div class="user-info">
            <span id="currentUser">ê²ŒìŠ¤íŠ¸</span>
            <button id="adminBtn" class="logout-btn" onclick="openAdminModal()" style="display: none; margin-right: 1rem;">ğŸ‘‘ íšŒì›ê´€ë¦¬</button>
            <a href="/logout" class="logout-btn">ë¡œê·¸ì•„ì›ƒ</a>
        </div>
    </div>

    <div class="container">
        <div class="calendar-header">
            <button class="btn btn-primary" onclick="openAddModal()">ğŸ“ ì¼ì • ì¶”ê°€</button>
            <button class="btn btn-success" onclick="refreshCalendar()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
            
            <div class="view-toggle">
                <button class="view-option active" onclick="setViewMode('my')" id="myViewBtn">ë‚´ ì¼ì •</button>
                <button class="view-option" onclick="setViewMode('all')" id="allViewBtn">ì „ì²´ ì¼ì •</button>
            </div>
            
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color own-color"></div>
                    <span>ë‚´ ì¼ì •</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color shared-color"></div>
                    <span>ê³µìœ ëœ ì¼ì •</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color all-color"></div>
                    <span>ë‹¤ë¥¸ ì‚¬ìš©ì ì¼ì •</span>
                </div>
            </div>
        </div>

        <div class="calendar-container">
            <div id="calendar"></div>
        </div>
    </div>

    <!-- ì¼ì • ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addEventModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('addEventModal')">&times;</span>
            <h2>ğŸ“ ì¼ì • ì¶”ê°€</h2>
            <form id="addEventForm">
                
                <div class="form-group">
                    <label for="addDescription">ì„¤ëª… (ì„ íƒ)</label>
                    <textarea id="addDescription" placeholder="ì¼ì •ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…"></textarea>
                </div>

                <div class="time-section">
                    <h4>ğŸ“… ì‹œì‘ ì‹œê°„</h4>
                    <div class="date-input">
                        <label for="addStartDate">ë‚ ì§œ</label>
                        <input type="date" id="addStartDate" required>
                    </div>
                    <div class="ampm-selector">
                        <div class="ampm-option selected" data-time="start" data-ampm="am">ì˜¤ì „</div>
                        <div class="ampm-option" data-time="start" data-ampm="pm">ì˜¤í›„</div>
                    </div>
                    <div class="time-picker-group">
                        <select id="addStartHour">
                            <option value="1">1ì‹œ</option>
                            <option value="2">2ì‹œ</option>
                            <option value="3">3ì‹œ</option>
                            <option value="4">4ì‹œ</option>
                            <option value="5">5ì‹œ</option>
                            <option value="6">6ì‹œ</option>
                            <option value="7">7ì‹œ</option>
                            <option value="8">8ì‹œ</option>
                            <option value="9" selected>9ì‹œ</option>
                            <option value="10">10ì‹œ</option>
                            <option value="11">11ì‹œ</option>
                            <option value="12">12ì‹œ</option>
                        </select>
                        <select id="addStartMinute">
                            <option value="0" selected>00ë¶„</option>
                            <option value="30">30ë¶„</option>
                        </select>
                    </div>
                </div>

                <div class="time-section">
                    <h4>â° ì¢…ë£Œ ì‹œê°„</h4>
                    <div class="date-input" style="display: none;">
                        <label for="addEndDate">ë‚ ì§œ</label>
                        <input type="date" id="addEndDate">
                    </div>
                    <div class="time-note">
                        <small style="color: #666; font-style: italic;">
                            ğŸ’¡ ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì´ë¥´ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒë‚ ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.
                        </small>
                    </div>
                    <div class="ampm-selector">
                        <div class="ampm-option selected" data-time="end" data-ampm="am">ì˜¤ì „</div>
                        <div class="ampm-option" data-time="end" data-ampm="pm">ì˜¤í›„</div>
                    </div>
                    <div class="time-picker-group">
                        <select id="addEndHour">
                            <option value="1">1ì‹œ</option>
                            <option value="2">2ì‹œ</option>
                            <option value="3">3ì‹œ</option>
                            <option value="4">4ì‹œ</option>
                            <option value="5">5ì‹œ</option>
                            <option value="6">6ì‹œ</option>
                            <option value="7">7ì‹œ</option>
                            <option value="8">8ì‹œ</option>
                            <option value="9">9ì‹œ</option>
                            <option value="10" selected>10ì‹œ</option>
                            <option value="11">11ì‹œ</option>
                            <option value="12">12ì‹œ</option>
                        </select>
                        <select id="addEndMinute">
                            <option value="0" selected>00ë¶„</option>
                            <option value="30">30ë¶„</option>
                        </select>
                    </div>
                </div>

                <div id="addConflictAlert" class="error-alert">
                    âš ï¸ <span id="addConflictMessage"></span>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" id="addSubmitBtn">ì¶”ê°€</button>
                    <button type="button" class="btn" onclick="closeModal('addEventModal')" style="background: #6c757d; color: white;">ì·¨ì†Œ</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ì¼ì • ìƒì„¸/ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="eventDetailModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('eventDetailModal')">&times;</span>
            <h2 id="eventDetailTitle">ì¼ì • ìƒì„¸</h2>
            
            <div id="eventDetailView">
                <div class="event-details">
                    <h3 id="detailTitle"></h3>
                    <p><strong>ğŸ“… ì‹œì‘:</strong> <span id="detailStartTime"></span></p>
                    <p><strong>â° ì¢…ë£Œ:</strong> <span id="detailEndTime"></span></p>
                    <p><strong>ğŸ“ ì„¤ëª…:</strong> <span id="detailDescription"></span></p>
                    <p><strong>ğŸ‘¤ ì‘ì„±ì:</strong> <span id="detailCreator"></span></p>
                </div>
                <div class="form-actions">
                    <button id="editEventBtn" class="btn btn-primary" onclick="switchToEditMode()">ìˆ˜ì •</button>
                    <button id="shareEventBtn" class="btn btn-success" onclick="showShareSection()">ê³µìœ </button>
                    <button id="deleteEventBtn" class="btn btn-danger" onclick="deleteCurrentEvent()">ì‚­ì œ</button>
                </div>
            </div>

            <div id="eventEditForm" style="display: none;">
                <form id="eventUpdateForm">
                    <input type="hidden" id="editEventId">
                    <div class="form-group">
                        <label for="editDescription">ì„¤ëª…</label>
                        <textarea id="editDescription" placeholder="ì¼ì •ì— ëŒ€í•œ ìƒì„¸ ì„¤ëª…"></textarea>
                    </div>

                    <div class="time-section">
                        <h4>ğŸ“… ì‹œì‘ ì‹œê°„</h4>
                        <div class="date-input">
                            <label for="editStartDate">ë‚ ì§œ</label>
                            <input type="date" id="editStartDate" required>
                        </div>
                        <div class="ampm-selector">
                            <div class="ampm-option selected" data-time="editStart" data-ampm="am">ì˜¤ì „</div>
                            <div class="ampm-option" data-time="editStart" data-ampm="pm">ì˜¤í›„</div>
                        </div>
                        <div class="time-picker-group">
                            <select id="editStartHour">
                                <option value="1">1ì‹œ</option>
                                <option value="2">2ì‹œ</option>
                                <option value="3">3ì‹œ</option>
                                <option value="4">4ì‹œ</option>
                                <option value="5">5ì‹œ</option>
                                <option value="6">6ì‹œ</option>
                                <option value="7">7ì‹œ</option>
                                <option value="8">8ì‹œ</option>
                                <option value="9" selected>9ì‹œ</option>
                                <option value="10">10ì‹œ</option>
                                <option value="11">11ì‹œ</option>
                                <option value="12">12ì‹œ</option>
                            </select>
                            <select id="editStartMinute">
                                <option value="0" selected>00ë¶„</option>
                                <option value="30">30ë¶„</option>
                            </select>
                        </div>
                    </div>

                    <div class="time-section">
                        <h4>â° ì¢…ë£Œ ì‹œê°„</h4>
                        <div class="date-input">
                            <label for="editEndDate">ë‚ ì§œ</label>
                            <input type="date" id="editEndDate" required>
                        </div>
                        <div class="ampm-selector">
                            <div class="ampm-option" data-time="editEnd" data-ampm="am">ì˜¤ì „</div>
                            <div class="ampm-option selected" data-time="editEnd" data-ampm="pm">ì˜¤í›„</div>
                        </div>
                        <div class="time-picker-group">
                            <select id="editEndHour">
                                <option value="1">1ì‹œ</option>
                                <option value="2">2ì‹œ</option>
                                <option value="3">3ì‹œ</option>
                                <option value="4">4ì‹œ</option>
                                <option value="5">5ì‹œ</option>
                                <option value="6" selected>6ì‹œ</option>
                                <option value="7">7ì‹œ</option>
                                <option value="8">8ì‹œ</option>
                                <option value="9">9ì‹œ</option>
                                <option value="10">10ì‹œ</option>
                                <option value="11">11ì‹œ</option>
                                <option value="12">12ì‹œ</option>
                            </select>
                            <select id="editEndMinute">
                                <option value="0" selected>00ë¶„</option>
                                <option value="30">30ë¶„</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="editConflictAlert" class="error-alert">
                        âš ï¸ <span id="editConflictMessage"></span>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" id="editSubmitBtn">ì €ì¥</button>
                        <button type="button" class="btn" onclick="switchToViewMode()" style="background: #6c757d; color: white;">ì·¨ì†Œ</button>
                    </div>
                </form>
            </div>

            <div id="shareSection" class="share-section" style="display: none;">
                <h3>ğŸ“¤ ì¼ì • ê³µìœ </h3>
                <div class="form-group">
                    <label for="shareUsername">ê³µìœ í•  ì‚¬ìš©ì</label>
                    <select id="shareUsername">
                        <option value="">ì‚¬ìš©ì ì„ íƒ</option>
                    </select>
                </div>
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="canEdit">
                        <label for="canEdit">í¸ì§‘ ê¶Œí•œ ë¶€ì—¬</label>
                    </div>
                </div>
                <button type="button" class="btn btn-success" onclick="shareCurrentEvent()">ê³µìœ í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ê´€ë¦¬ì ëª¨ë‹¬ -->
    <div id="adminModal" class="modal">
        <div class="modal-content">
            <span class="close" onclick="closeModal('adminModal')">&times;</span>
            <h2>ğŸ‘‘ íšŒì› ê´€ë¦¬</h2>
            
            <div class="admin-section">
                <h3>ğŸ“Š íšŒì› ëª©ë¡</h3>
                <div id="usersList" class="users-list">
                    <div class="loading">íšŒì› ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let calendar;
        let currentEvents = [];
        let allEvents = [];
        let currentUsers = [];
        let selectedEvent = null;
        let viewMode = 'my'; // 'my' ë˜ëŠ” 'all'
        let startAmPm = 'am';
        let endAmPm = 'am';

        // ë‚ ì§œ í¬ë§·íŒ… í•¨ìˆ˜ë“¤
        function formatDateTime(dateTimeStr) {
            const date = new Date(dateTimeStr);
            return date.toLocaleString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: true,
                timeZone: 'Asia/Seoul'
            });
        }

        function formatDateTimeForInput(dateTimeStr) {
            const date = new Date(dateTimeStr);
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        }

        // ì‹œê°„ ì¡°í•© í•¨ìˆ˜
        function combineDateTime(date, hour, minute, ampm) {
            let actualHour = parseInt(hour);
            if (ampm === 'pm' && actualHour !== 12) {
                actualHour += 12;
            } else if (ampm === 'am' && actualHour === 12) {
                actualHour = 0;
            }
            
            // ë¡œì»¬ ì‹œê°„ëŒ€ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì²˜ë¦¬
            const [year, month, day] = date.split('-').map(Number);
            const dateTime = new Date(year, month - 1, day, actualHour, parseInt(minute));
            return dateTime;
        }

        // ìŠ¤ë§ˆíŠ¸ ë‚ ì§œ ì‹œê°„ ì¡°í•© í•¨ìˆ˜ (ìë™ ë‚ ì§œ ì¡°ì •)
        function combineSmartDateTime(startDate, startHour, startMinute, startAmpm, endHour, endMinute, endAmpm) {
            const startTime = combineDateTime(startDate, startHour, startMinute, startAmpm);
            let endTime = combineDateTime(startDate, endHour, endMinute, endAmpm);
            
            // ì¢…ë£Œ ì‹œê°„ì´ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ì´ë¥´ë©´ ë‹¤ìŒë‚ ë¡œ ì„¤ì •
            if (endTime <= startTime) {
                endTime.setDate(endTime.getDate() + 1);
            }
            
            return { startTime, endTime };
        }

        // ì‹œê°„ ì¤‘ë³µ í™•ì¸ í•¨ìˆ˜
        function checkTimeConflict(startTime, endTime, excludeEventId = null) {
            const conflicts = [];
            const newStart = new Date(startTime);
            const newEnd = new Date(endTime);
            
            const eventsToCheck = viewMode === 'all' ? allEvents : currentEvents;
            
            eventsToCheck.forEach(event => {
                if (excludeEventId && event.id == excludeEventId) return;
                
                const eventStart = new Date(event.start_time);
                const eventEnd = new Date(event.end_time);
                
                if (newStart < eventEnd && newEnd > eventStart) {
                    conflicts.push(event);
                }
            });
            
            return conflicts;
        }

        // ì¤‘ë³µ ê²€ì‚¬ ë° UI ì—…ë°ì´íŠ¸
        function updateAddFormConflictStatus() {
            const startDate = document.getElementById('addStartDate').value;
            const startHour = document.getElementById('addStartHour').value;
            const startMinute = document.getElementById('addStartMinute').value;
            const endHour = document.getElementById('addEndHour').value;
            const endMinute = document.getElementById('addEndMinute').value;
            
            if (!startDate) return;
            
            const { startTime, endTime } = combineSmartDateTime(startDate, startHour, startMinute, startAmPm, endHour, endMinute, endAmPm);
            
            const alertElement = document.getElementById('addConflictAlert');
            const messageElement = document.getElementById('addConflictMessage');
            const submitBtn = document.getElementById('addSubmitBtn');
            
            const conflicts = checkTimeConflict(startTime, endTime);
            
            if (conflicts.length > 0) {
                const conflictTitles = conflicts.map(c => `"${c.title}"`).join(', ');
                messageElement.textContent = `ë‹¤ìŒ ì¼ì •ê³¼ ì‹œê°„ì´ ê²¹ì¹©ë‹ˆë‹¤: ${conflictTitles}`;
                alertElement.classList.add('show');
                submitBtn.disabled = true;
            } else {
                alertElement.classList.remove('show');
                submitBtn.disabled = false;
            }
        }

        // ì˜¤ì „/ì˜¤í›„ ì„ íƒ ì´ë²¤íŠ¸ ì„¤ì •
        function setupTimeSelectors() {
            document.querySelectorAll('.ampm-option').forEach(option => {
                option.addEventListener('click', function() {
                    const timeType = this.dataset.time;
                    const ampm = this.dataset.ampm;
                    
                    // ê°™ì€ ì‹œê°„ëŒ€ì˜ ë‹¤ë¥¸ ì˜µì…˜ë“¤ ì„ íƒ í•´ì œ
                    document.querySelectorAll(`.ampm-option[data-time="${timeType}"]`).forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // í˜„ì¬ ì˜µì…˜ ì„ íƒ
                    this.classList.add('selected');
                    
                    // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                    if (timeType === 'start') {
                        startAmPm = ampm;
                        updateAddFormConflictStatus();
                    } else if (timeType === 'end') {
                        endAmPm = ampm;
                        updateAddFormConflictStatus();
                    }
                    // editStart, editEndëŠ” ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸ ë¶ˆí•„ìš” (ë¡œì»¬ì—ì„œ ì²˜ë¦¬)
                });
            });

            // ì‹œê°„/ë¶„ ë³€ê²½ ê°ì§€
            ['addStartHour', 'addStartMinute', 'addEndHour', 'addEndMinute', 'addStartDate'].forEach(id => {
                document.getElementById(id).addEventListener('change', updateAddFormConflictStatus);
            });
        }

        // ë·° ëª¨ë“œ ì„¤ì •
        function setViewMode(mode) {
            viewMode = mode;
            
            // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.view-option').forEach(btn => btn.classList.remove('active'));
            document.getElementById(mode === 'my' ? 'myViewBtn' : 'allViewBtn').classList.add('active');
            
            // ë‹¬ë ¥ ì—…ë°ì´íŠ¸
            refreshCalendar();
        }

        // ëª¨ë‹¬ ê´€ë¦¬ í•¨ìˆ˜ë“¤
        function openAddModal(dateStr = null) {
            const modal = document.getElementById('addEventModal');
            
            const today = dateStr || new Date().toISOString().split('T')[0];
            document.getElementById('addStartDate').value = today;
            // ì¢…ë£Œ ë‚ ì§œëŠ” ìë™ìœ¼ë¡œ ê³„ì‚°ë˜ë¯€ë¡œ ì„¤ì •í•˜ì§€ ì•ŠìŒ
            
            // ì‹œê°„ ì´ˆê¸°í™”
            document.getElementById('addStartHour').value = '9';
            document.getElementById('addStartMinute').value = '0';
            document.getElementById('addEndHour').value = '10';
            document.getElementById('addEndMinute').value = '0';
            
            // ì˜¤ì „/ì˜¤í›„ ì´ˆê¸°í™”
            document.querySelectorAll('.ampm-option').forEach(opt => opt.classList.remove('selected'));
            document.querySelectorAll('.ampm-option[data-ampm="am"]').forEach(opt => opt.classList.add('selected'));
            startAmPm = 'am';
            endAmPm = 'am';
            
            // í¼ ë¦¬ì…‹
            document.getElementById('addDescription').value = '';
            document.getElementById('addConflictAlert').classList.remove('show');
            document.getElementById('addSubmitBtn').disabled = false;
            
            modal.style.display = 'block';
            updateAddFormConflictStatus();
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
            if (modalId === 'eventDetailModal') {
                switchToViewMode();
                document.getElementById('shareSection').style.display = 'none';
            }
        }

        function switchToEditMode() {
            document.getElementById('eventDetailView').style.display = 'none';
            document.getElementById('eventEditForm').style.display = 'block';
            document.getElementById('eventDetailTitle').textContent = 'ì¼ì • ìˆ˜ì •';
        }

        function switchToViewMode() {
            document.getElementById('eventEditForm').style.display = 'none';
            document.getElementById('eventDetailView').style.display = 'block';
            document.getElementById('eventDetailTitle').textContent = 'ì¼ì • ìƒì„¸';
        }

        function showShareSection() {
            const shareSection = document.getElementById('shareSection');
            shareSection.style.display = shareSection.style.display === 'none' ? 'block' : 'none';
            if (shareSection.style.display === 'block') {
                loadUsers();
            }
        }

        // ë°ì´í„° ë¡œë”© í•¨ìˆ˜ë“¤
        async function loadEvents() {
            try {
                const response = await fetch('/api/events');
                const events = await response.json();
                currentEvents = events;
                return events;
            } catch (error) {
                console.error('ë‚´ ì¼ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                return [];
            }
        }

        async function loadAllEvents() {
            try {
                const response = await fetch('/api/events/all');
                const events = await response.json();
                allEvents = events;
                return events;
            } catch (error) {
                console.error('ì „ì²´ ì¼ì • ë¡œë“œ ì‹¤íŒ¨:', error);
                return [];
            }
        }

        async function loadUsers() {
            try {
                const response = await fetch('/api/users');
                const users = await response.json();
                currentUsers = users;
                
                const select = document.getElementById('shareUsername');
                select.innerHTML = '<option value="">ì‚¬ìš©ì ì„ íƒ</option>';
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('ì‚¬ìš©ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ë‹¬ë ¥ ì´ˆê¸°í™”
        function initializeCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                timeZone: 'local',
                height: 'auto',
                nextDayThreshold: '00:00:00',  // ìì • ì´í›„ ì¼ì •ì„ ë‹¤ìŒë‚ ë¡œ ì—°ê²°í•˜ì§€ ì•ŠìŒ
                displayEventEnd: false,  // ì¢…ë£Œ ì‹œê°„ í‘œì‹œí•˜ì§€ ì•ŠìŒ (ë‹¤ìŒë‚  ì—°ê²° ë°©ì§€)
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay'
                },
                buttonText: {
                    today: 'ì˜¤ëŠ˜',
                    month: 'ì›”',
                    week: 'ì£¼',
                    day: 'ì¼'
                },
                eventClick: function(info) {
                    showEventDetail(info.event.extendedProps.originalEvent);
                },
                dateClick: function(info) {
                    openAddModal(info.dateStr);
                },
                eventDidMount: function(info) {
                    const start = new Date(info.event.start).toLocaleTimeString('ko-KR', {
                        hour: '2-digit', 
                        minute:'2-digit',
                        hour12: true,
                        timeZone: 'Asia/Seoul'
                    });
                    const end = new Date(info.event.end).toLocaleTimeString('ko-KR', {
                        hour: '2-digit', 
                        minute:'2-digit',
                        hour12: true,
                        timeZone: 'Asia/Seoul'
                    });
                    info.el.title = `${info.event.title}\n${start} - ${end}\nì‘ì„±ì: ${info.event.extendedProps.creator}`;
                }
            });
            
            calendar.render();
        }

        // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨
        async function refreshCalendar() {
            let events = [];
            
            if (viewMode === 'my') {
                events = await loadEvents();
            } else {
                events = await loadAllEvents();
            }
            
            const calendarEvents = events.map(event => {
                let className = 'all-event';
                if (viewMode === 'my') {
                    className = event.is_owner ? 'own-event' : 'shared-event';
                }
                
                // ì¼ì •ì´ ë‹¤ìŒë‚ ë¡œ ë„˜ì–´ê°€ëŠ” ê²½ìš° ì‹œì‘ ë‚ ì§œì—ë§Œ í‘œì‹œ
                const startDate = new Date(event.start_time);
                const endDate = new Date(event.end_time);
                
                let displayEnd = event.end_time;
                if (startDate.toDateString() !== endDate.toDateString()) {
                    // ë‹¤ìŒë‚ ë¡œ ë„˜ì–´ê°€ëŠ” ê²½ìš° ì‹œì‘ ë‚ ì§œì˜ 23:59:59ë¡œ ì œí•œ
                    const sameDay = new Date(startDate);
                    sameDay.setHours(23, 59, 59, 999);
                    displayEnd = sameDay.toISOString();
                }
                
                return {
                    id: event.id,
                    title: event.title,
                    start: event.start_time,
                    end: displayEnd,
                    description: event.description,
                    extendedProps: {
                        creator: event.creator,
                        isOwner: event.is_owner,
                        originalEvent: event
                    },
                    className: className
                };
            });

            if (calendar) {
                calendar.removeAllEvents();
                calendar.addEventSource(calendarEvents);
            }
        }

        // ì¼ì • ìƒì„¸ í‘œì‹œ
        function showEventDetail(event) {
            selectedEvent = event;
            
            document.getElementById('detailTitle').textContent = event.title;
            document.getElementById('detailDescription').textContent = event.description || 'ì„¤ëª… ì—†ìŒ';
            document.getElementById('detailStartTime').textContent = formatDateTime(event.start_time);
            document.getElementById('detailEndTime').textContent = formatDateTime(event.end_time);
            document.getElementById('detailCreator').textContent = event.creator;
            
            // í¸ì§‘ í¼ì— ë°ì´í„° ì„¤ì •
            document.getElementById('editEventId').value = event.id;
            document.getElementById('editDescription').value = event.description || '';
            
            // ì‹œì‘ ì‹œê°„ ì„¤ì •
            const startDate = new Date(event.start_time);
            const startYear = startDate.getFullYear();
            const startMonth = String(startDate.getMonth() + 1).padStart(2, '0');
            const startDay = String(startDate.getDate()).padStart(2, '0');
            document.getElementById('editStartDate').value = `${startYear}-${startMonth}-${startDay}`;
            
            let startHour = startDate.getHours();
            let startAmPm = 'am';
            if (startHour === 0) {
                startHour = 12;
            } else if (startHour > 12) {
                startHour -= 12;
                startAmPm = 'pm';
            } else if (startHour === 12) {
                startAmPm = 'pm';
            }
            
            document.getElementById('editStartHour').value = startHour;
            document.getElementById('editStartMinute').value = startDate.getMinutes();
            
            // ì‹œì‘ ì‹œê°„ ì˜¤ì „/ì˜¤í›„ ë²„íŠ¼ ì„¤ì •
            document.querySelectorAll('[data-time="editStart"]').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.ampm === startAmPm) {
                    btn.classList.add('selected');
                }
            });
            
            // ì¢…ë£Œ ì‹œê°„ ì„¤ì •
            const endDate = new Date(event.end_time);
            const endYear = endDate.getFullYear();
            const endMonth = String(endDate.getMonth() + 1).padStart(2, '0');
            const endDay = String(endDate.getDate()).padStart(2, '0');
            document.getElementById('editEndDate').value = `${endYear}-${endMonth}-${endDay}`;
            
            let endHour = endDate.getHours();
            let endAmPm = 'am';
            if (endHour === 0) {
                endHour = 12;
            } else if (endHour > 12) {
                endHour -= 12;
                endAmPm = 'pm';
            } else if (endHour === 12) {
                endAmPm = 'pm';
            }
            
            document.getElementById('editEndHour').value = endHour;
            document.getElementById('editEndMinute').value = endDate.getMinutes();
            
            // ì¢…ë£Œ ì‹œê°„ ì˜¤ì „/ì˜¤í›„ ë²„íŠ¼ ì„¤ì •
            document.querySelectorAll('[data-time="editEnd"]').forEach(btn => {
                btn.classList.remove('selected');
                if (btn.dataset.ampm === endAmPm) {
                    btn.classList.add('selected');
                }
            });
            
            // ë²„íŠ¼ í‘œì‹œ/ìˆ¨ê¹€ (ê´€ë¦¬ìì´ê±°ë‚˜ ë‚´ ì¼ì •ì¸ ê²½ìš° í¸ì§‘ ê°€ëŠ¥)
            const canEdit = isAdmin || (event.is_owner && viewMode === 'my');
            const canShare = event.is_owner && viewMode === 'my'; // ê³µìœ ëŠ” ë³¸ì¸ ì¼ì •ë§Œ
            document.getElementById('editEventBtn').style.display = canEdit ? 'inline-block' : 'none';
            document.getElementById('shareEventBtn').style.display = canShare ? 'inline-block' : 'none';
            document.getElementById('deleteEventBtn').style.display = canEdit ? 'inline-block' : 'none';
            
            document.getElementById('eventDetailModal').style.display = 'block';
        }

        // ì¼ì • ê´€ë¦¬ í•¨ìˆ˜ë“¤
        async function createEvent(eventData) {
            try {
                const response = await fetch('/api/events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                });

                if (response.ok) {
                    showMessage('ì¼ì •ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    refreshCalendar();
                    return true;
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'ì¼ì • ì¶”ê°€ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    return false;
                }
            } catch (error) {
                console.error('ì¼ì • ì¶”ê°€ ì‹¤íŒ¨:', error);
                showMessage('ì¼ì • ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return false;
            }
        }

        async function updateEvent(eventData) {
            try {
                const response = await fetch(`/api/events/${eventData.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(eventData)
                });

                if (response.ok) {
                    showMessage('ì¼ì •ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    refreshCalendar();
                    closeModal('eventDetailModal');
                    return true;
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'ì¼ì • ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                    return false;
                }
            } catch (error) {
                console.error('ì¼ì • ìˆ˜ì • ì‹¤íŒ¨:', error);
                showMessage('ì¼ì • ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                return false;
            }
        }

        async function deleteCurrentEvent() {
            if (!selectedEvent || !confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/events/${selectedEvent.id}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    showMessage('ì¼ì •ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                    refreshCalendar();
                    closeModal('eventDetailModal');
                } else {
                    showMessage('ì¼ì • ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('ì¼ì • ì‚­ì œ ì‹¤íŒ¨:', error);
                showMessage('ì¼ì • ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function shareCurrentEvent() {
            if (!selectedEvent) return;
            
            const username = document.getElementById('shareUsername').value;
            const canEdit = document.getElementById('canEdit').checked;
            
            if (!username) {
                showMessage('ê³µìœ í•  ì‚¬ìš©ìë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }

            try {
                const response = await fetch('/api/share', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        event_id: selectedEvent.id,
                        username: username,
                        can_edit: canEdit
                    })
                });

                const result = await response.json();
                
                if (response.ok && result.success) {
                    showMessage('ì¼ì •ì´ ì„±ê³µì ìœ¼ë¡œ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                    document.getElementById('shareUsername').value = '';
                    document.getElementById('canEdit').checked = false;
                    document.getElementById('shareSection').style.display = 'none';
                } else {
                    showMessage(result.error || 'ì¼ì • ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                console.error('ì¼ì • ê³µìœ  ì‹¤íŒ¨:', error);
                showMessage('ì¼ì • ê³µìœ  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function showMessage(message, type = 'info') {
            const existingMessage = document.querySelector('.message-toast');
            if (existingMessage) {
                existingMessage.remove();
            }

            const messageEl = document.createElement('div');
            messageEl.className = `message-toast ${type === 'error' ? 'error-message' : 'success-message'}`;
            messageEl.textContent = message;
            messageEl.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 10000;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                max-width: 400px;
                animation: slideInRight 0.3s ease-out;
            `;
            
            document.body.appendChild(messageEl);
            
            setTimeout(() => {
                messageEl.remove();
            }, 3000);
        }

        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë“¤
        document.getElementById('addEventForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const startDate = document.getElementById('addStartDate').value;
            const startHour = document.getElementById('addStartHour').value;
            const startMinute = document.getElementById('addStartMinute').value;
            const endHour = document.getElementById('addEndHour').value;
            const endMinute = document.getElementById('addEndMinute').value;
            
            const { startTime, endTime } = combineSmartDateTime(startDate, startHour, startMinute, startAmPm, endHour, endMinute, endAmPm);
            
            console.log('ì‹œê°„ ì…ë ¥ ê°’:', {
                startDate, startHour, startMinute, startAmPm,
                endHour, endMinute, endAmPm
            });
            console.log('ë³€í™˜ëœ ì‹œê°„:', {
                startTime: startTime.toString(),
                endTime: endTime.toString()
            });
            
            // ë¡œì»¬ ì‹œê°„ëŒ€ ì˜¤í”„ì…‹ì„ ê³ ë ¤í•œ ISO ë¬¸ìì—´ ìƒì„±
            function toLocalISOString(date) {
                const offset = date.getTimezoneOffset();
                const localDate = new Date(date.getTime() - offset * 60000);
                return localDate.toISOString();
            }
            
            // í˜„ì¬ ì‚¬ìš©ì ì´ë¦„ì„ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
            const currentUsername = document.getElementById('currentUser').textContent.replace('ë‹˜', '');
            
            const eventData = {
                title: currentUsername,
                description: document.getElementById('addDescription').value,
                start_time: toLocalISOString(startTime),
                end_time: toLocalISOString(endTime)
            };
            
            const success = await createEvent(eventData);
            if (success) {
                closeModal('addEventModal');
                document.getElementById('addEventForm').reset();
            }
        });

        document.getElementById('eventUpdateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const editStartDate = document.getElementById('editStartDate').value;
            const editStartHour = document.getElementById('editStartHour').value;
            const editStartMinute = document.getElementById('editStartMinute').value;
            const editEndDate = document.getElementById('editEndDate').value;
            const editEndHour = document.getElementById('editEndHour').value;
            const editEndMinute = document.getElementById('editEndMinute').value;
            
            // í˜„ì¬ ì„ íƒëœ ì˜¤ì „/ì˜¤í›„ í™•ì¸
            const editStartAmPm = document.querySelector('[data-time="editStart"].selected').dataset.ampm;
            const editEndAmPm = document.querySelector('[data-time="editEnd"].selected').dataset.ampm;
            
            const editStartTime = combineDateTime(editStartDate, editStartHour, editStartMinute, editStartAmPm);
            const editEndTime = combineDateTime(editEndDate, editEndHour, editEndMinute, editEndAmPm);
            
            // ë¡œì»¬ ì‹œê°„ëŒ€ ì˜¤í”„ì…‹ì„ ê³ ë ¤í•œ ISO ë¬¸ìì—´ ìƒì„±
            function toLocalISOString(date) {
                const offset = date.getTimezoneOffset();
                const localDate = new Date(date.getTime() - offset * 60000);
                return localDate.toISOString();
            }
            
            // í˜„ì¬ ì‚¬ìš©ì ì´ë¦„ì„ ì œëª©ìœ¼ë¡œ ì‚¬ìš©
            const currentUsername = document.getElementById('currentUser').textContent.replace('ë‹˜', '');
            
            const eventData = {
                id: document.getElementById('editEventId').value,
                title: currentUsername,
                description: document.getElementById('editDescription').value,
                start_time: toLocalISOString(editStartTime),
                end_time: toLocalISOString(editEndTime)
            };
            
            const success = await updateEvent(eventData);
            if (success) {
                switchToViewMode();
            }
        });

        // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ì‹œ ë‹«ê¸°
        window.onclick = function(event) {
            const addModal = document.getElementById('addEventModal');
            const detailModal = document.getElementById('eventDetailModal');
            const adminModal = document.getElementById('adminModal');
            
            if (event.target === addModal) {
                closeModal('addEventModal');
            } else if (event.target === detailModal) {
                closeModal('eventDetailModal');
            } else if (event.target === adminModal) {
                closeModal('adminModal');
            }
        }

        // ê´€ë¦¬ì ê´€ë ¨ í•¨ìˆ˜ë“¤
        let isAdmin = false;
        let allUsers = [];


        async function loadAllUsers() {
            try {
                const response = await fetch('/api/admin/users');
                if (response.ok) {
                    allUsers = await response.json();
                    displayUsers();
                } else {
                    showMessage('ì‚¬ìš©ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showMessage('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function displayUsers() {
            const usersList = document.getElementById('usersList');
            
            if (allUsers.length === 0) {
                usersList.innerHTML = '<div class="loading">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }

            const usersHTML = allUsers.map(user => `
                <div class="user-item">
                    <div class="user-info-admin">
                        <div class="user-name">
                            ${user.username}
                            ${user.is_admin ? '<span class="admin-badge">ğŸ‘‘ ê´€ë¦¬ì</span>' : ''}
                        </div>
                        <div class="user-stats">
                            ê°€ì…ì¼: ${new Date(user.created_at).toLocaleDateString('ko-KR')} | 
                            ì¼ì • ìˆ˜: ${user.event_count}ê°œ
                        </div>
                    </div>
                    <div class="user-actions">
                        <button class="btn btn-info btn-small" onclick="changeUsername(${user.id}, '${user.username}')">
                            âœï¸ ì´ë¦„ ë³€ê²½
                        </button>
                        <button class="btn btn-primary btn-small" onclick="changeUserPassword(${user.id}, '${user.username}')">
                            ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                        </button>
                        ${!user.is_admin ? `
                            <button class="btn btn-danger btn-small" onclick="deleteUser(${user.id}, '${user.username}')">
                                ì‚­ì œ
                            </button>
                        ` : '<span style="color: #666;">ì‚­ì œ ë¶ˆê°€</span>'}
                    </div>
                </div>
            `).join('');

            usersList.innerHTML = usersHTML;
        }

        async function changeUsername(userId, currentUsername) {
            const newUsername = prompt(`${currentUsername}ì˜ ìƒˆ ì‚¬ìš©ìëª…ì„ ì…ë ¥í•˜ì„¸ìš”:`, currentUsername);
            if (!newUsername || newUsername === currentUsername) {
                return;
            }

            if (newUsername.length < 1) {
                alert('ì‚¬ìš©ìëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/username`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        new_username: newUsername
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message, 'success');
                    loadAllUsers(); // ì‚¬ìš©ì ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    refreshCalendar(); // ë‹¬ë ¥ë„ ìƒˆë¡œê³ ì¹¨ (ì´ë¦„ì´ ë°”ë€Œì—ˆìœ¼ë¯€ë¡œ)
                } else {
                    const result = await response.json();
                    showMessage(result.error || 'ì‚¬ìš©ìëª… ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showMessage('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function changeUserPassword(userId, username) {
            const newPassword = prompt(`${username}ì˜ ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”:`);
            if (!newPassword) {
                return;
            }

            if (newPassword.length < 1) {
                alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        new_password: newPassword
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    showMessage(result.message, 'success');
                } else {
                    const result = await response.json();
                    showMessage(result.error || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showMessage('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        async function deleteUser(userId, username) {
            if (!confirm(`ì •ë§ë¡œ "${username}" ì‚¬ìš©ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, í•´ë‹¹ ì‚¬ìš©ìì˜ ëª¨ë“  ì¼ì •ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage(`"${username}" ì‚¬ìš©ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                    loadAllUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    refreshCalendar(); // ë‹¬ë ¥ ìƒˆë¡œê³ ì¹¨
                } else {
                    const error = await response.json();
                    showMessage(error.error || 'ì‚¬ìš©ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                showMessage('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function openAdminModal() {
            document.getElementById('adminModal').style.display = 'block';
            loadAllUsers();
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
        async function displayCurrentUser() {
            const currentUserElement = document.getElementById('currentUser');
            
            try {
                const response = await fetch('/api/current-user');
                if (response.ok) {
                    const userData = await response.json();
                    currentUserElement.textContent = userData.username + 'ë‹˜';
                    
                    // ê´€ë¦¬ìì¸ ê²½ìš° ë°°ì§€ ì¶”ê°€
                    if (userData.is_admin) {
                        currentUserElement.innerHTML += ' <span class="admin-badge">ğŸ‘‘ ê´€ë¦¬ì</span>';
                        document.getElementById('adminBtn').style.display = 'inline-block';
                        isAdmin = true;
                    }
                } else {
                    currentUserElement.textContent = 'ê²ŒìŠ¤íŠ¸';
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                currentUserElement.textContent = 'ê²ŒìŠ¤íŠ¸';
            }
        }

        // ì´ˆê¸°í™”
        window.onload = function() {
            displayCurrentUser();
            initializeCalendar();
            setupTimeSelectors();
            refreshCalendar();
        };

        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideInRight {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>